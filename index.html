import React, { useMemo, useState, useEffect } from "react";
import { motion } from "framer-motion";
import { Plus, Upload, ShoppingBasket, Trash2, Search, Edit3, ChevronRight, Calculator, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

// -----------------------------
// Types
// -----------------------------

type Item = {
  id: string;
  name: string;
  price: number; // unit cost in KRW
};

type BoxLine = {
  itemId: string;
  qty: number;
};

type Box = {
  id: string;
  title: string;
  lines: BoxLine[];
};

// -----------------------------
// Helpers
// -----------------------------

const currency = (n: number) => n.toLocaleString("ko-KR");
const uid = () => Math.random().toString(36).slice(2, 9);

// basic CSV parser (RFC4180-light). We keep it inline to avoid external deps
function parseCSV(raw: string): string[][] {
  const rows: string[][] = [];
  let i = 0, cur = '', row: string[] = [], inQuotes = false;
  while (i < raw.length) {
    const ch = raw[i];
    if (inQuotes) {
      if (ch === '"') {
        if (raw[i + 1] === '"') { cur += '"'; i++; }
        else { inQuotes = false; }
      } else cur += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { row.push(cur.trim()); cur = ''; }
      else if (ch === '\n') { row.push(cur.trim()); rows.push(row); row = []; cur = ''; }
      else if (ch === '\r') { /* skip */ }
      else cur += ch;
    }
    i++;
  }
  // push last cell
  if (cur.length || row.length) { row.push(cur.trim()); rows.push(row); }
  // drop empty trailing rows
  return rows.filter(r => r.length && !(r.length === 1 && r[0] === ''));
}

function titleFromIndex(i: number) {
  return `구성 ${i + 1}`;
}

// -----------------------------
// Main App
// -----------------------------

export default function RandomBoxBuilder() {
  // business settings
  const [listPrice, setListPrice] = useState<number>(3500); // 정가
  const [marginRate, setMarginRate] = useState<number>(10); // %

  // items state
  const [items, setItems] = useState<Item[]>([
    // 샘플 데이터 (파일 업로드 전 미리 사용 가능)
    { id: uid(), name: "로투수", price: 198 },
    { id: uid(), name: "바프 아몬드", price: 550 },
    { id: uid(), name: "초코비", price: 620 },
    { id: uid(), name: "젤리 스트로우", price: 170 },
    { id: uid(), name: "츄파춥스", price: 430 },
  ]);

  // boxes state
  const [boxes, setBoxes] = useState<Box[]>([{ id: uid(), title: titleFromIndex(0), lines: [] }]);
  const [activeBoxId, setActiveBoxId] = useState<string>(boxes[0].id);

  // UI state
  const [query, setQuery] = useState("");
  const [showUploadDialog, setShowUploadDialog] = useState(false);
  const [csvPreview, setCsvPreview] = useState<string[][]>([]);
  const [colNameIdx, setColNameIdx] = useState<number>(0);
  const [colPriceIdx, setColPriceIdx] = useState<number>(1);

  // derived
  const activeBox = boxes.find(b => b.id === activeBoxId) ?? boxes[0];

  const budgetPerBox = useMemo(() => Math.round(listPrice * (1 - marginRate / 100)), [listPrice, marginRate]);

  function addBox() {
    setBoxes(prev => {
      const next = [...prev, { id: uid(), title: titleFromIndex(prev.length), lines: [] }];
      return next;
    });
  }

  function removeBox(id: string) {
    setBoxes(prev => prev.filter(b => b.id !== id));
    setTimeout(() => {
      setActiveBoxId(prev => (prev === id && boxes[0] ? boxes[0].id : prev));
    }, 0);
  }

  function addItemToActive(itemId: string) {
    setBoxes(prev => prev.map(b => {
      if (b.id !== activeBoxId) return b;
      const existing = b.lines.find(l => l.itemId === itemId);
      if (existing) {
        return { ...b, lines: b.lines.map(l => l.itemId === itemId ? { ...l, qty: l.qty + 1 } : l) };
      }
      return { ...b, lines: [...b.lines, { itemId, qty: 1 }] };
    }));
  }

  function setQty(boxId: string, itemId: string, qty: number) {
    setBoxes(prev => prev.map(b => b.id !== boxId ? b : ({
      ...b,
      lines: b.lines.map(l => l.itemId === itemId ? { ...l, qty: Math.max(0, Math.floor(qty || 0)) } : l)
    })));
  }

  function deleteLine(boxId: string, itemId: string) {
    setBoxes(prev => prev.map(b => b.id !== boxId ? b : ({
      ...b,
      lines: b.lines.filter(l => l.itemId !== itemId)
    })));
  }

  function findItem(id: string) {
    return items.find(i => i.id === id)!;
  }

  function boxCost(b: Box) {
    return b.lines.reduce((sum, l) => sum + findItem(l.itemId).price * l.qty, 0);
  }

  function boxItemCount(b: Box) {
    return b.lines.reduce((sum, l) => sum + l.qty, 0);
  }

  const filteredItems = useMemo(() => {
    const q = query.trim();
    if (!q) return items;
    return items.filter(i => i.name.toLowerCase().includes(q.toLowerCase()));
  }, [query, items]);

  // -----------------------------
  // CSV Upload Handling
  // -----------------------------

  function onCSVChosen(file: File) {
    const reader = new FileReader();
    reader.onload = e => {
      const text = String(e.target?.result || "");
      const rows = parseCSV(text);
      setCsvPreview(rows.slice(0, 25));
      // default guess: first row is header
      setColNameIdx(0);
      setColPriceIdx(1);
      setShowUploadDialog(true);
    };
    reader.readAsText(file, 'utf-8');
  }

  function applyCSVMapping() {
    if (!csvPreview.length) return;
    const [header, ...rest] = csvPreview;
    const allRows = [header, ...rest];

    // Re-parse from the dialog's preview source would only include first 25 rows.
    // To load full file, we need to re-read the file; simpler approach: advise user to click "완료" to accept the preview
    // BUT better approach: store full text on first read; let's keep a quick solution: we will use the preview rows now.

    // If header looks like a header (non-numeric price column), skip it when mapping
    const startIdx = (() => {
      const priceHead = header[colPriceIdx];
      const maybeNum = Number(String(priceHead).replace(/[^0-9.\-]/g, ""));
      return Number.isFinite(maybeNum) ? 0 : 1;
    })();

    const mapped: Item[] = [];
    for (let r = startIdx; r < allRows.length; r++) {
      const row = allRows[r];
      if (!row) continue;
      const name = String(row[colNameIdx] ?? "").trim();
      const priceRaw = String(row[colPriceIdx] ?? "").trim();
      if (!name) continue;
      const num = Number(priceRaw.replace(/[^0-9.\-]/g, ""));
      if (!Number.isFinite(num)) continue;
      mapped.push({ id: uid(), name, price: Math.round(num) });
    }
    if (mapped.length) {
      setItems(mapped);
      setShowUploadDialog(false);
    }
  }

  // -----------------------------
  // Components
  // -----------------------------

  const Stat = ({ label, value, highlight = false }: { label: string, value: React.ReactNode, highlight?: boolean }) => (
    <div className="flex flex-col p-3 rounded-2xl border bg-white/60">
      <span className="text-xs text-muted-foreground">{label}</span>
      <span className={`text-lg font-semibold ${highlight ? 'text-green-600' : ''}`}>{value}</span>
    </div>
  );

  function BoxCard({ b, idx }: { b: Box, idx: number }) {
    const cost = boxCost(b);
    const variance = budgetPerBox - cost; // + = under budget, - = over
    const achievedMarginPct = listPrice > 0 ? Math.round(((listPrice - cost) / listPrice) * 1000) / 10 : 0;
    const priceNeeded = Math.ceil(cost / (1 - marginRate / 100));

    return (
      <motion.div layout>
        <Card className={`hover:shadow-md transition-shadow cursor-pointer ${activeBoxId === b.id ? 'ring-2 ring-zinc-900/10' : ''}`} onClick={() => setActiveBoxId(b.id)}>
          <CardHeader className="flex flex-row items-center justify-between gap-2">
            <CardTitle className="flex items-center gap-2 text-base">
              <ShoppingBasket className="w-4 h-4" />
              {b.title}
              <Badge variant="secondary" className="ml-1">{boxItemCount(b)}개</Badge>
            </CardTitle>
            <div className="flex items-center gap-2">
              <Button variant="outline" size="icon" onClick={(e) => { e.stopPropagation(); removeBox(b.id); }}>
                <Trash2 className="w-4 h-4" />
              </Button>
            </div>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
              <Stat label="총 원가" value={`${currency(cost)}원`} />
              <Stat label="목표 원가(정가·마진)" value={`${currency(budgetPerBox)}원`} />
              <Stat label="차이(목표-원가)" value={`${variance >= 0 ? '+' : ''}${currency(variance)}원`} highlight={variance >= 0} />
              <Stat label="현재 정가 마진율" value={`${achievedMarginPct}%`} />
            </div>
            <div className="text-xs text-muted-foreground flex items-center gap-2">
              <Calculator className="w-3.5 h-3.5" />
              10% 마진을 유지하려면 필요한 정가 ≈ <span className="font-semibold">{currency(priceNeeded)}원</span>
            </div>
            {b.lines.length > 0 ? (
              <div className="border rounded-2xl p-2">
                {b.lines.map((l) => {
                  const it = findItem(l.itemId);
                  return (
                    <div key={l.itemId} className="flex items-center justify-between gap-2 py-1">
                      <div className="text-sm">
                        {it.name} <span className="text-muted-foreground">({currency(it.price)}원)</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="flex items-center gap-1">
                          <Input type="number" className="w-16 h-8" value={l.qty} min={0}
                                 onClick={(e) => e.stopPropagation()}
                                 onChange={(e) => setQty(b.id, l.itemId, Number(e.target.value))} />
                          <span className="text-xs text-muted-foreground">개</span>
                        </div>
                        <Badge variant="outline">{currency(it.price * l.qty)}원</Badge>
                        <Button variant="ghost" size="icon" onClick={(e) => { e.stopPropagation(); deleteLine(b.id, l.itemId); }}>
                          <X className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">왼쪽(또는 아래)의 품목 목록에서 클릭하여 추가하세요.</div>
            )}
          </CardContent>
        </Card>
      </motion.div>
    );
  }

  // Summary across boxes
  const SummaryStrip = () => (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
      <Stat label="박스 개수" value={`${boxes.length}개`} />
      <Stat label="총 아이템 수(전체)" value={`${boxes.reduce((s, b) => s + boxItemCount(b), 0)}개`} />
      <Stat label="총 원가 합계" value={`${currency(boxes.reduce((s, b) => s + boxCost(b), 0))}원`} />
    </div>
  );

  return (
    <div className="p-4 md:p-6 max-w-6xl mx-auto">
      <div className="flex flex-col md:flex-row gap-4">
        {/* Left: Item Catalog */}
        <div className="md:w-1/3 space-y-3">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle className="text-base">품목 목록</CardTitle>
              <div className="flex items-center gap-2">
                <label htmlFor="csv-file" className="flex items-center gap-1">
                  <input id="csv-file" type="file" accept=".csv" className="hidden"
                         onChange={(e) => {
                           const f = e.target.files?.[0];
                           if (f) onCSVChosen(f);
                         }} />
                  <Button size="sm" variant="outline">
                    <Upload className="w-4 h-4 mr-1" /> CSV 업로드
                  </Button>
                </label>
              </div>
            </CardHeader>
            <CardContent className="space-y-2">
              <div className="relative">
                <Search className="absolute left-2 top-2.5 w-4 h-4 text-muted-foreground" />
                <Input placeholder="품목 검색" className="pl-8" value={query} onChange={(e) => setQuery(e.target.value)} />
              </div>
              <div className="max-h-[420px] overflow-auto pr-1 space-y-1">
                {filteredItems.map(it => (
                  <button key={it.id} onClick={() => addItemToActive(it.id)}
                          className="w-full text-left px-3 py-2 rounded-xl border hover:bg-muted/60 flex items-center justify-between">
                    <span className="text-sm">{it.name} <span className="text-muted-foreground">({currency(it.price)}원)</span></span>
                    <ChevronRight className="w-4 h-4" />
                  </button>
                ))}
                {filteredItems.length === 0 && (
                  <div className="text-sm text-muted-foreground py-6 text-center">검색 결과가 없습니다.</div>
                )}
              </div>
              <div className="text-xs text-muted-foreground">
                항목을 클릭하면 현재 선택된 박스에 추가됩니다. (괄호 안은 개별 단가)
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="text-base">가격/마진 설정</CardTitle>
            </CardHeader>
            <CardContent className="grid grid-cols-2 gap-3">
              <div>
                <Label htmlFor="listPrice">정가(원)</Label>
                <Input id="listPrice" type="number" value={listPrice}
                       onChange={(e) => setListPrice(Math.max(0, Math.floor(Number(e.target.value) || 0)))} />
              </div>
              <div>
                <Label htmlFor="marginRate">마진율(%)</Label>
                <Input id="marginRate" type="number" value={marginRate}
                       onChange={(e) => setMarginRate(Math.max(0, Math.floor(Number(e.target.value) || 0)))} />
              </div>
              <div className="col-span-2 grid grid-cols-2 gap-2">
                <Stat label="목표 원가(= 정가 × (1-마진))" value={`${currency(budgetPerBox)}원`} />
                <Stat label="필요 정가(= 원가 ÷ (1-마진))" value="각 박스 카드에 표시" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Right: Boxes */}
        <div className="md:w-2/3 space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-semibold flex items-center gap-2">
              랜덤박스 구성
              <Badge variant="secondary">한눈에 보기</Badge>
            </h2>
            <Button onClick={addBox} className="gap-2"><Plus className="w-4 h-4" /> 새 박스 추가</Button>
          </div>

          <SummaryStrip />

          <div className="grid grid-cols-1 gap-3">
            {boxes.map((b, idx) => (
              <BoxCard key={b.id} b={b} idx={idx} />
            ))}
          </div>
        </div>
      </div>

      {/* CSV Mapping Dialog */}
      <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>CSV 컬럼 매핑</DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <p className="text-sm text-muted-foreground">
              업로드한 CSV에서 <b>품목명</b>과 <b>단가</b>가 들어있는 열을 선택하세요. (첫 25행 미리보기)
            </p>
            {csvPreview.length > 0 ? (
              <div className="space-y-3">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <Label>품목명 열</Label>
                    <Select value={String(colNameIdx)} onValueChange={(v) => setColNameIdx(Number(v))}>
                      <SelectTrigger className="w-full"><SelectValue placeholder="열 선택" /></SelectTrigger>
                      <SelectContent>
                        {csvPreview[0].map((_, i) => (
                          <SelectItem key={i} value={String(i)}>{`열 ${i + 1}`}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label>단가 열</Label>
                    <Select value={String(colPriceIdx)} onValueChange={(v) => setColPriceIdx(Number(v))}>
                      <SelectTrigger className="w-full"><SelectValue placeholder="열 선택" /></SelectTrigger>
                      <SelectContent>
                        {csvPreview[0].map((_, i) => (
                          <SelectItem key={i} value={String(i)}>{`열 ${i + 1}`}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className="max-h-64 overflow-auto border rounded-xl">
                  <table className="w-full text-sm">
                    <thead className="bg-muted">
                      <tr>
                        {csvPreview[0].map((h, i) => (
                          <th key={i} className={`p-2 text-left ${i===colNameIdx? 'text-blue-600': i===colPriceIdx? 'text-emerald-600': ''}`}>열 {i+1}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {csvPreview.map((row, rIdx) => (
                        <tr key={rIdx} className="border-t">
                          {row.map((cell, cIdx) => (
                            <td key={cIdx} className={`p-2 ${cIdx===colNameIdx? 'bg-blue-50': cIdx===colPriceIdx? 'bg-emerald-50': ''}`}>{cell}</td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="flex justify-end gap-2">
                  <Button variant="outline" onClick={() => setShowUploadDialog(false)}>취소</Button>
                  <Button onClick={applyCSVMapping}>완료</Button>
                </div>
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">CSV 미리보기를 불러오는 중 문제가 발생했습니다. 다시 시도해주세요.</div>
            )}
          </div>
        </DialogContent>
      </Dialog>

      <div className="mt-6 text-xs text-muted-foreground">
        • 박스를 클릭하면 해당 박스가 선택되고, 왼쪽 품목을 클릭할 때 그 박스에 추가됩니다. <br />
        • 각 품목 오른쪽 괄호에 개별 단가를 표시합니다. <br />
        • 정가(기본 3,500원)와 마진율(기본 10%)을 바꾸면 목표 원가가 자동 계산됩니다. <br />
        • 카드 하단의 계산 영역에서 현재 정가 기준 마진율과 필요한 정가를 확인할 수 있습니다.
      </div>
    </div>
  );
}
